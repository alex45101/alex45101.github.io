<style>
    .center {
        margin: auto;
        margin-top: 2.5%;
        margin-bottom: 1.5%;
        text-align: center;
    }

    table.center {
        border: solid;
        text-align: right;
    }
</style>

<html>

<head>
    <title>Rainbow Six Team Picker</title>
    <h1 class="center">Rainbow Six Team Picker</h1>
</head>

<body>
    <form>
        <h2 class="center">Players</h2>
        <div class="center" id="usernameButtons"></div>
        <div class="center" id="teamOptions">
            <button type="button" value="Skill" onclick="makeTeams(this)">Skill</button>
            <button type="button" value="Random" onclick="makeTeams(this)">Random</button>
        </div>
        <div id="teamLineUp"></div>
    </form>
</body>

</html>

<script>

    var usernames = ["SmexyBoy130", "AstrologyMan", "Can_You_Dont", "edjr125", "Irsh_Walf", "Llamalpaca", "Negus-", "ShangYang28", "t00sp00ky4u", "TheSneakyAdolf", "Uvuvwevweonyete"];

    var players = [];
    var playingPlayers = [];

    class Player {
        constructor(username, button) {
            this.username = username;
            this.button = button;
            this.isPlaying = false;
            this.hasUserInfo = false;
            this.team = -1;
            this.kd = 0;
            this.wlr = 0;
            this.playTime = 0;
            this.points = 0;
        }

        GetUserInfo() {
            if (!this.button.firstClick) {
                getUserStats(this.username, (response) => {
                    console.log("Got " + this.username + "'s stats");
                    this.hasUserInfo = true;

                    if (this.isPlaying) {
                        this.button.style.backgroundColor = "green";
                    }

                    let info = JSON.parse(response);

                    if (!info.player.stats.ranked.has_played) {
                        this.kd = info.player.stats.casual.kd;
                        this.wlr = info.player.stats.casual.wlr;
                        this.playTime = info.player.stats.casual.playtime;
                    }
                    else {
                        this.kd = (info.player.stats.casual.kd + info.player.stats.ranked.kd) / 2;
                        this.wlr = (info.player.stats.casual.wlr + info.player.stats.ranked.wlr) / 2;
                        this.playTime = info.player.stats.casual.playtime + info.player.stats.ranked.playtime;
                    }

                    this.points += this.kd / 0.1;
                    this.points += this.kd / 0.075;
                    this.points += ((this.playTime / 60) / 60) / 50;

                    console.log("KD: " + this.kd);
                    console.log("WLR: " + this.wlr);
                    console.log("PlayTime: " + (this.playTime / 60) / 60);
                    console.log("Points: " + this.points);
                });
            }
        }
    }

    document.body.onload = () => {
        setUpTable();
        setUpPlayerButtons();
    }

    function setUpTable() {
        let tableDiv = document.getElementById("teamLineUp");
        let table = document.createElement("TABLE");
        table.classList.add("center");

        for (var i = 0, count = 0; i < 5; i++) {
            let row = document.createElement("tr");
            for (var j = 0; j < 2; j++ , count++) {
                let cell = document.createElement("td");
                cell.style.border = "solid";
                cell.style.borderColor = "black";
                cell.style.padding = "15px 50px 15px 50px"
                cell.style.color = "white";

                cell.id = count;

                if (j % 2 == 0) {
                    cell.team = "blue";
                }
                else {
                    cell.team = "orange";
                }

                cell.style.backgroundColor = cell.team;

                row.appendChild(cell);
            }

            table.appendChild(row);
        }

        tableDiv.appendChild(table);
    }

    function setUpPlayerButtons() {
        let usernameDiv = document.getElementById("usernameButtons");

        for (let i = 0; i < usernames.length; i++) {
            let usernameButton = document.createElement("input");
            usernameButton.type = "button";
            usernameButton.value = usernames[i];
            usernameButton.selected = false;
            usernameButton.firstClick = false;

            players.push(new Player(usernameButton.value, usernameButton));
            players.isPlaying = false;

            usernameButton.onclick = (event) => {
                usernameButton.selected = !usernameButton.selected;
                players[i].isPlaying = usernameButton.selected;

                if (!players[i].hasUserInfo) {
                    players[i].GetUserInfo();
                }

                if (usernameButton.selected) {
                    playingPlayers.push(players[i]);

                    if (players[i].hasUserInfo) {
                        usernameButton.style.backgroundColor = "green";
                    }
                    else {
                        usernameButton.style.backgroundColor = "yellow";
                    }
                }
                else {
                    playingPlayers.splice(i, 1);

                    usernameButton.style.backgroundColor = "";
                }

                console.log(playingPlayers);
                usernameButton.firstClick = true;
            };

            usernameDiv.appendChild(usernameButton);
        }
    }

    function fillCell(row, team, text) {
        let cell = document.getElementById((row * 2) + team);
        cell.innerText = text;
    }

    function clearTable() {
        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 2; j++) {
                fillCell(i, j, "");
            }
        }
    }

    function makeTeams(button) {
        clearTable();

        if (playingPlayers.length > 1 && playingPlayers.length <= 10) {
            if (button.value == "Skill") {
                for (var i = 0; i < playingPlayers.length; i++) {
                    if (!playingPlayers[i].hasUserInfo) {
                        alert("Not all player stats have been loaded. Wait till everyone has green on their name to use the skill feature");
                        return;
                    }
                }

                console.log("everyone loaded in");

                var pointTotal = 0;

                for (var i = 0; i < playingPlayers.length; i++) {
                    let offset = Math.floor(Math.random() * 3);
                    offset = 0;
                    let operation = Math.floor(Math.random() * 2);

                    if (operation % 2 == 0) {
                        playingPlayers[i].points += offset;
                    }
                    else {
                        playingPlayers[i].points -= offset;
                    }

                    pointTotal += playingPlayers[i].points;
                }

                console.log("Total Points: " + pointTotal);

                playingPlayers.sort((a, b) => { return b.points - a.points });

                console.log(playingPlayers);

                putPlayersInRandomTeams();

                var teamPoints = [0, 0];

                for(var i = 0; i < playingPlayers.length; i++){
                    if(playingPlayers[i].team == 0){
                        teamPoints[0] += playingPlayers[i].points;
                    }
                    else {
                        teamPoints[1] += playingPlayers[i].points;
                    }
                }

                console.log("Blue Team Points: " + teamPoints[0]);
                console.log("Orange Team Points: " + teamPoints[1]);
            }
            else if (button.value == "Random") {
                putPlayersInRandomTeams();
            }
        }
        else {
            alert("There is one player selected or more than 10 players are selected");
        }
    }

    function putPlayersInRandomTeams() {
        for (var i = 0, j = 0; i < playingPlayers.length - 1; i += 2, j++) {
            playingPlayers[i].team = Math.floor(Math.random() * 2);
            fillCell(j, playingPlayers[i].team, playingPlayers[i].username);
            console.log(playingPlayers[i].username + " joined team " + playingPlayers[i].team);

            playingPlayers[i + 1].team = playingPlayers[i].team + 1;
            playingPlayers[i + 1].team %= 2;
            fillCell(j, playingPlayers[i + 1].team, playingPlayers[i + 1].username);
            console.log(playingPlayers[i + 1].username + " joined team " + playingPlayers[i + 1].team);
        }

        if (playingPlayers.length % 2 == 1) {
            playingPlayers[playingPlayers.length - 1].team = Math.floor(Math.random() * 2);
            fillCell(Math.floor(playingPlayers.length / 2), playingPlayers[playingPlayers.length - 1].team, playingPlayers[playingPlayers.length - 1].username);
            console.log(playingPlayers[playingPlayers.length - 1].username + " joined team " + playingPlayers[playingPlayers.length - 1].team);
        }
    }

    function findPlayerIndex(username) {
        if (typeof username === "string") {
            for (var i = 0; i < players.length; i++) {
                if (username == players[i].username) {
                    return i;
                }
            }
        }

        return -1;
    }

    function getUserStats(username, runMe) {
        let request = new XMLHttpRequest();

        request.open("GET", "https://api.r6stats.com/api/v1/players/" + username + "?platform=uplay", true);
        request.setRequestHeader("Content-Type", "application/json");
        request.onreadystatechange = () => {
            if (request.readyState == 4 && request.status >= 200 && request.status < 300) {
                console.log("Request Post: " + request.responseText);
                runMe(request.responseText);
            }
        }

        request.send();
    }
</script>